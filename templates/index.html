<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>注文管理システム</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base-style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* ちょっとした余白 */
      body { padding: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans JP', 'Hiragino Kaku Gothic ProN', sans-serif; }
    </style>
</head>
<body>
    <h1>注文管理システム</h1>
    <ul>
      <li><a href="{{ url_for('user.list') }}">ユーザー（顧客）</a></li>
      <li><a href="{{ url_for('product.list') }}">製品</a></li>
      <li><a href="{{ url_for('order.list') }}">注文</a></li>
      <li><a href="{{ url_for('report.list') }}">統計</a></li>
      <li><a href="{{ url_for('review.list') }}">レビュー</a></li>
    </ul>

    <!-- 自動で JSON を読み込んで表示（選択フォームは不要） -->
    <h2>販売データ（order.json）の円グラフ：商品ごとの販売個数</h2>
    <div style="display:flex; gap:40px; align-items:flex-start;">
      <div>
        <h3>order: 商品別売上個数（円グラフ）</h3>
        <div style="width:420px; height:300px;">
          <canvas id="orderPie"></canvas>
        </div>
      </div>
    </div>

    <h2>report.json（月別売上）</h2>
    <div style="width:840px; height:300px; margin-top:16px;">
      <canvas id="reportChart"></canvas>
    </div>

    <script>
      // API からデータを取得してグラフを描画
      async function fetchJson(path) {
        try {
          const res = await fetch(path);
          if (!res.ok) return null;
          return await res.json();
        } catch (e) {
          return null;
        }
      }

      (async function() {
        // /api/order/product_counts -> [{product_id, product_name, count}, ...]
        const orderCounts = await fetchJson('/api/order/product_counts') || [];
        const orderLabels = orderCounts.map(r => r.product_name || String(r.product_id));
        const orderValues = orderCounts.map(r => r.count || 0);

        const pieCtx = document.getElementById('orderPie').getContext('2d');
        new Chart(pieCtx, {
          type: 'pie',
          data: {
            labels: orderLabels,
            datasets: [{
              data: orderValues,
              backgroundColor: orderLabels.map((_, i) => `hsl(${(i*60)%360} 70% 60%)`)
            }]
          },
          options: { responsive: true }
        });

        // /api/report/monthly_json -> { title, x_axis_label, y_axis_label, data: [{month, sales}, ...] }
        const reportData = await fetchJson('/api/report/monthly_json');
        const monthly = (reportData && reportData.data) ? reportData.data : [];
        const rlabels = monthly.map(d => d.month);
        const rvalues = monthly.map(d => d.sales || 0);

        const rctx = document.getElementById('reportChart').getContext('2d');
        new Chart(rctx, {
          type: 'line',
          data: {
            labels: rlabels,
            datasets: [{
              label: reportData ? reportData.title : '売上',
              data: rvalues,
              borderColor: 'rgba(75, 192, 192, 1)',
              backgroundColor: 'rgba(75, 192, 192, 0.1)',
              tension: 0.3,
              fill: true
            }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });

        // /api/user/age_distribution -> [{label, value}, ...] を棒グラフで表示
        const ageDist = await fetchJson('/api/user/age_distribution') || [];
        if (ageDist.length > 0) {
          const labels = ageDist.map(d => d.label);
          const vals = ageDist.map(d => d.value);
          // 挿入する場所を作る（画面下に）
          const container = document.createElement('div');
          container.style.width = '640px';
          container.style.height = '300px';
          container.style.marginTop = '20px';
          const h3 = document.createElement('h2');
          h3.textContent = '年齢分布';
          document.body.appendChild(h3);
          const c = document.createElement('canvas');
          c.id = 'ageChart';
          container.appendChild(c);
          document.body.appendChild(container);

          const actx = c.getContext('2d');
          new Chart(actx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: '人数',
                data: vals,
                backgroundColor: 'rgba(153, 102, 255, 0.6)'
              }]
            },
            options: { responsive: true, maintainAspectRatio: false }
          });
        }
      })();
    </script>
</body>
</html>
